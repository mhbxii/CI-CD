name: Build and Deploy to K8S local

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Login to DockerHub
      run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u mhbx12 --password-stdin
    
    - name: Build and push backend
      run: |
        docker build -t mhbx12/todo-backend:${{ github.sha }} ./backend
        docker push mhbx12/todo-backend:${{ github.sha }}
    
    - name: Build and push frontend
      run: |
        docker build -t mhbx12/todo-frontend:${{ github.sha }} ./frontend
        docker push mhbx12/todo-frontend:${{ github.sha }}
    
    - name: Update manifest repo with new image tags
      run: |
        git clone https://github.com/mhbxii/todo-app-manifests.git
        cd todo-app-manifests
        
        # Update image tags using kustomize
        cd base
        kustomize edit set image mhbx12/todo-backend:${{ github.sha }}
        kustomize edit set image mhbx12/todo-frontend:${{ github.sha }}
        
        # Commit and push
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add kustomization.yaml
        git commit -m "Update images to ${{ github.sha }}"
        git push https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/mhbxii/todo-app-manifests.git main